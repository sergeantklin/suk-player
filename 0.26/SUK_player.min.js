function getAudioContextClass(){var t=window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.oAudioContext||window.msAudioContext;if(t)var e=new t;return e}function getSoundTouchSource(t){var e={extract:function(e,i,r){var o=t.getSoundBuffer(),n=o.getChannelData(0);if(o.numberOfChannels>1)var s=o.getChannelData(1);else var s=o.getChannelData(0);for(var u=0;i>u;u++)e[2*u]=n[u+r],e[2*u+1]=s[u+r];return Math.min(i,n.length-r)}};return e}function SUK_Player(t){function e(t){if(x.getChannelData){for(var e=t.outputBuffer.getChannelData(0),i=t.outputBuffer.getChannelData(1),r=I.extract(X,K),o=0;r>o;o++)e[o]=X[2*o],i[o]=X[2*o+1];z.push(new Float32Array(e)),G.push(new Float32Array(i)),0==r&&(l(!0),_())}}function i(){var t=y*(k*g.sampleRate);t=Math.round(x.length*y),F=new SoundTouch,F.pitch=j,F.tempo=w,I=new SimpleFilter(W,F),I.sourcePosition=t}function r(e,i){g.decodeAudioData(e,function(e){-1!=P.src.indexOf(i)&&(x=e,k=x.duration,t.onDecode&&t.onDecode())},function(e){-1!=P.src.indexOf(i)&&t.onDecodeError&&t.onDecodeError(e)})}function o(t){g&&(U?(l(!0),j=t,c(!0)):j=t)}function n(t){if(g)for(var e=t,i=0,r=e.length;r>i;i++)Q[i].gain.value=e[i]}function s(){g&&n([0,0,0,0,0,0,0,0,0,0])}function u(t){U?(l(!0),y=t,c(!0)):y=t}function a(t){w=t,P.playbackRate=t,g&&U&&1!=j&&(l(!0),c(!0))}function f(t){g?N.gain.value=t:0>t||t>1||(P.volume=t)}function h(t){g&&(t.connect(N),N.connect(Q[0]),Q[Q.length-1].connect(g.destination))}function c(e){try{if(1==j){var r=P.duration&&y&&P.duration*y||0;P.currentTime=r,h(R),P.play()}else i(),h(q);e||t.onPlay&&t.onPlay(),U=!0}catch(o){}}function p(){return P.duration}function l(e){1==j?P.pause():q.disconnect(),e||t.onPause&&t.onPause(),U=!1}function _(){S(),t.onEnd&&t.onEnd()}function d(e){D&&D.abort(),D=new XMLHttpRequest,D.open("GET",e,!0),D.responseType="arraybuffer",D.onload=function(){t.onLoad&&t.onLoad(),r(D.response,e)},D.onprogress=function(e){t.onLoadProgress&&t.onLoadProgress(e.loaded/e.total)},D.onerror=function(e){t.onLoadError&&t.onLoadError(e)},D.onabort=function(e){t.onLoadAbort&&t.onLoadAbort(e)},D.send()}function S(){l(),P.currentTime&&(P.currentTime=0),a(1),o(1),u(0),f(1),s(),g&&(x=g.createBuffer(2,22050,44100))}function v(t){V=!1,S(),P.src="",P.src=t,g&&d(t)}function m(){return x}function B(){if(U){var e=0;1==j?(e=P.currentTime,y=P.currentTime/P.duration):(y=I.sourcePosition/(k*g.sampleRate),e=y*k),t.onTimeUpdate&&t.onTimeUpdate(e)}}function E(){function e(){L.shift(),E()}if(C&&(C.abort(),C=null),L.length>0){var i=L[0];C=new XMLHttpRequest,C.open("GET",i,!0),C.responseType="arraybuffer",C.onload=function(){t.onPreload&&t.onPreload(i),e()},C.onerror=function(t){e()},C.send()}}function A(t){return t&&0!=t.length?void(L.length>0&&L[0]==t[0]?L=t:(L=t,E())):(L=[],void E())}function T(){U=!1,P.preload="media",P.controls=!0,P.onended=_,P.onerror=function(e){t.onPlayerError&&t.onPlayerError(e.currentTarget.error)},P.onwaiting=function(){t.onBuffer&&t.onBuffer()},P.onplaying=function(){t.onBufferEnd&&t.onBufferEnd()},P.onstalled=function(){t.onPlayerError&&t.onPlayerError("stalled")},P.onsuspend=function(){t.onPlayerError&&t.onPlayerError("suspend")},P.onabort=function(){t.onPlayerError&&t.onPlayerError("abort")},P.oncanplay=function(e){V||(V=!0,t.onCanPlay&&t.onCanPlay())},g&&(Q=b(),N=g.createGain(),R=g.createMediaElementSource(P),q.onaudioprocess=e),M=setInterval(B,100)}function b(){function t(t){var e=g.createBiquadFilter();return e.type="peaking",e.frequency.value=t,e.Q.value=1,e.gain.value=0,e}var e,i=[60,170,310,600,1e3,3e3,6e3,12e3,14e3,16e3];return e=i.map(t),e.reduce(function(t,e){return t.connect(e),e}),e}t=t||{};var O={},g=getAudioContextClass();g||t.onAudioContextError&&t.onAudioContextError();var C,M,P=new Audio,L=[],y=0,j=1,w=1,U=!1;if(g)var F,k,x,R,I,Q,N,D,K=4096,W=getSoundTouchSource(O),q=g.createScriptProcessor?g.createScriptProcessor(K,2,2):g.createJavaScriptNode(K,2,2),X=new Float32Array(2*K),z=[],G=[],V=!1;return T(),O.initParams=t,O.load=v,O.play=c,O.pause=l,O.getSoundBuffer=m,O.setTone=o,O.setPosition=u,O.setFilter=n,O.setSpeed=a,O.setVolume=f,O.getDuration=p,O.detachFilter=s,O.preload=A,O.version=.26,O}function extend(t,e){var i=window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.oAudioContext||window.msAudioContext;if(!i)return t;for(var r in e){var o=e.__lookupGetter__(r),n=e.__lookupSetter__(r);o||n?(o&&t.__defineGetter__(r,o),n&&t.__defineSetter__(r,n)):t[r]=e[r]}return t}function testFloatEqual(t,e){return(t>e?t-e:e-t)>1e-10}function AbstractFifoSamplePipe(t){t?(this.inputBuffer=new FifoSampleBuffer,this.outputBuffer=new FifoSampleBuffer):this.inputBuffer=this.outputBuffer=null}function RateTransposer(t){AbstractFifoSamplePipe.call(this,t),this._reset(),this.rate=1}function FifoSampleBuffer(){this._vector=new Float32Array,this._position=0,this._frameCount=0}function FilterSupport(t){this._pipe=t}function SimpleFilter(t,e){FilterSupport.call(this,e),this.sourceSound=t,this.historyBufferSize=22050,this._sourcePosition=0,this.outputBufferPosition=0,this._position=0}function Stretch(t){AbstractFifoSamplePipe.call(this,t),this.bQuickSeek=!0,this.bMidBufferDirty=!1,this.pMidBuffer=null,this.overlapLength=0,this.bAutoSeqSetting=!0,this.bAutoSeekSetting=!0,this._tempo=1,this.setParameters(44100,DEFAULT_SEQUENCE_MS,DEFAULT_SEEKWINDOW_MS,DEFAULT_OVERLAP_MS)}function SoundTouch(){this.rateTransposer=new RateTransposer(!1),this.tdStretch=new Stretch(!1),this._inputBuffer=new FifoSampleBuffer,this._intermediateBuffer=new FifoSampleBuffer,this._outputBuffer=new FifoSampleBuffer,this._rate=0,this.tempo=0,this.virtualPitch=1,this.virtualRate=1,this.virtualTempo=1,this._calculateEffectiveRateAndTempo()}AbstractFifoSamplePipe.prototype={get inputBuffer(){return this._inputBuffer},set inputBuffer(t){this._inputBuffer=t},get outputBuffer(){return this._outputBuffer},set outputBuffer(t){this._outputBuffer=t},clear:function(){this._inputBuffer.clear(),this._outputBuffer.clear()}},extend(RateTransposer.prototype,AbstractFifoSamplePipe.prototype),extend(RateTransposer.prototype,{set rate(t){this._rate=t},_reset:function(){this.slopeCount=0,this.prevSampleL=0,this.prevSampleR=0},clone:function(){var t=new RateTransposer;return t.rate=this._rate,t},process:function(){var t=this._inputBuffer.frameCount;this._outputBuffer.ensureAdditionalCapacity(t/this._rate+1);var e=this._transpose(t);this._inputBuffer.receive(),this._outputBuffer.put(e)},_transpose:function(t){if(0==t)return 0;for(var e=this._inputBuffer.vector,i=this._inputBuffer.startIndex,r=this._outputBuffer.vector,o=this._outputBuffer.endIndex,n=0,s=0;this.slopeCount<1;)r[o+2*s]=(1-this.slopeCount)*this.prevSampleL+this.slopeCount*e[i],r[o+2*s+1]=(1-this.slopeCount)*this.prevSampleR+this.slopeCount*e[i+1],s++,this.slopeCount+=this._rate;if(this.slopeCount-=1,1!=t)t:for(;;){for(;this.slopeCount>1;)if(this.slopeCount-=1,n++,n>=t-1)break t;var u=i+2*n;r[o+2*s]=(1-this.slopeCount)*e[u]+this.slopeCount*e[u+2],r[o+2*s+1]=(1-this.slopeCount)*e[u+1]+this.slopeCount*e[u+3],s++,this.slopeCount+=this._rate}return this.prevSampleL=e[i+2*t-2],this.prevSampleR=e[i+2*t-1],s}}),FifoSampleBuffer.prototype={get vector(){return this._vector},get position(){return this._position},get startIndex(){return 2*this._position},get frameCount(){return this._frameCount},get endIndex(){return 2*(this._position+this._frameCount)},clear:function(){this.receive(frameCount),this.rewind()},put:function(t){this._frameCount+=t},putSamples:function(t,e,i){e=e||0;var r=2*e;i>=0||(i=(t.length-r)/2);var o=2*i;this.ensureCapacity(i+this._frameCount);var n=this.endIndex;this._vector.set(t.subarray(r,r+o),n),this._frameCount+=i},putBuffer:function(t,e,i){e=e||0,i>=0||(i=t.frameCount-e),this.putSamples(t.vector,t.position+e,i)},receive:function(t){(!(t>=0)||t>this._frameCount)&&(t=this._frameCount),this._frameCount-=t,this._position+=t},receiveSamples:function(t,e){var i=2*e,r=this.startIndex;t.set(this._vector.subarray(r,r+i)),this.receive(e)},extract:function(t,e,i){var r=this.startIndex+2*e,o=2*i;t.set(this._vector.subarray(r,r+o))},ensureCapacity:function(t){var e=parseInt(2*t);if(this._vector.length<e){var i=new Float32Array(e);i.set(this._vector.subarray(this.startIndex,this.endIndex)),this._vector=i,this._position=0}else this.rewind()},ensureAdditionalCapacity:function(t){this.ensureCapacity(this.frameCount+t)},rewind:function(){this._position>0&&(this._vector.set(this._vector.subarray(this.startIndex,this.endIndex)),this._position=0)}},FilterSupport.prototype={get pipe(){return this._pipe},get inputBuffer(){return this._pipe.inputBuffer},get outputBuffer(){return this._pipe.outputBuffer},fillOutputBuffer:function(t){for(;this.outputBuffer.frameCount<t;){var e=16384-this.inputBuffer.frameCount;if(this.fillInputBuffer(e),this.inputBuffer.frameCount<16384)break;this._pipe.process()}},clear:function(){this._pipe.clear()}},extend(SimpleFilter.prototype,FilterSupport.prototype),extend(SimpleFilter.prototype,{get position(){return this._position},set position(t){var e=this.outputBufferPosition-(this._position-t);this.outputBufferPosition=e,this._position=t},get sourcePosition(){return this._sourcePosition},set sourcePosition(t){this.clear(),this._sourcePosition=t},fillInputBuffer:function(t){var e=new Float32Array(2*t),i=this.sourceSound.extract(e,t,this._sourcePosition);this._sourcePosition+=i,this.inputBuffer.putSamples(e,0,i)},extract:function(t,e){this.fillOutputBuffer(this.outputBufferPosition+e);var i=Math.min(e,this.outputBuffer.frameCount-this.outputBufferPosition);this.outputBuffer.extract(t,this.outputBufferPosition,i);var r=this.outputBufferPosition+i;return this.outputBufferPosition=Math.min(this.historyBufferSize,r),this.outputBuffer.receive(Math.max(r-this.historyBufferSize,0)),this._position+=i,i},handleSampleData:function(t){this.extract(t.data,4096)},clear:function(){this.outputBufferPosition=0}});var USE_AUTO_SEQUENCE_LEN=0,DEFAULT_SEQUENCE_MS=USE_AUTO_SEQUENCE_LEN,USE_AUTO_SEEKWINDOW_LEN=0,DEFAULT_SEEKWINDOW_MS=USE_AUTO_SEEKWINDOW_LEN,DEFAULT_OVERLAP_MS=8,_SCAN_OFFSETS=[[124,186,248,310,372,434,496,558,620,682,744,806,868,930,992,1054,1116,1178,1240,1302,1364,1426,1488,0],[-100,-75,-50,-25,25,50,75,100,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[-20,-15,-10,-5,5,10,15,20,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[-4,-3,-2,-1,1,2,3,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],AUTOSEQ_TEMPO_LOW=.5,AUTOSEQ_TEMPO_TOP=2,AUTOSEQ_AT_MIN=125,AUTOSEQ_AT_MAX=50,AUTOSEQ_K=(AUTOSEQ_AT_MAX-AUTOSEQ_AT_MIN)/(AUTOSEQ_TEMPO_TOP-AUTOSEQ_TEMPO_LOW),AUTOSEQ_C=AUTOSEQ_AT_MIN-AUTOSEQ_K*AUTOSEQ_TEMPO_LOW,AUTOSEEK_AT_MIN=25,AUTOSEEK_AT_MAX=15,AUTOSEEK_K=(AUTOSEEK_AT_MAX-AUTOSEEK_AT_MIN)/(AUTOSEQ_TEMPO_TOP-AUTOSEQ_TEMPO_LOW),AUTOSEEK_C=AUTOSEEK_AT_MIN-AUTOSEEK_K*AUTOSEQ_TEMPO_LOW;extend(Stretch.prototype,AbstractFifoSamplePipe.prototype),extend(Stretch.prototype,{clear:function(){AbstractFifoSamplePipe.prototype.clear.call(this),this._clearMidBuffer()},_clearMidBuffer:function(){this.bMidBufferDirty&&(this.bMidBufferDirty=!1,this.pMidBuffer=null)},setParameters:function(t,e,i,r){t>0&&(this.sampleRate=t),r>0&&(this.overlapMs=r),e>0?(this.sequenceMs=e,this.bAutoSeqSetting=!1):this.bAutoSeqSetting=!0,i>0?(this.seekWindowMs=i,this.bAutoSeekSetting=!1):this.bAutoSeekSetting=!0,this.calcSeqParameters(),this.calculateOverlapLength(this.overlapMs),this.tempo=this._tempo},set tempo(t){var e;this._tempo=t,this.calcSeqParameters(),this.nominalSkip=this._tempo*(this.seekWindowLength-this.overlapLength),this.skipFract=0,e=Math.floor(this.nominalSkip+.5),this.sampleReq=Math.max(e+this.overlapLength,this.seekWindowLength)+this.seekLength},get inputChunkSize(){return this.sampleReq},get outputChunkSize(){return this.overlapLength+Math.max(0,this.seekWindowLength-2*this.overlapLength)},calculateOverlapLength:function(t){var e;e=this.sampleRate*t/1e3,16>e&&(e=16),e-=e%8,this.overlapLength=e,this.pRefMidBuffer=new Float32Array(2*this.overlapLength),this.pMidBuffer=new Float32Array(2*this.overlapLength)},checkLimits:function(t,e,i){return e>t?e:t>i?i:t},calcSeqParameters:function(){var t,e;this.bAutoSeqSetting&&(t=AUTOSEQ_C+AUTOSEQ_K*this._tempo,t=this.checkLimits(t,AUTOSEQ_AT_MAX,AUTOSEQ_AT_MIN),this.sequenceMs=Math.floor(t+.5)),this.bAutoSeekSetting&&(e=AUTOSEEK_C+AUTOSEEK_K*this._tempo,e=this.checkLimits(e,AUTOSEEK_AT_MAX,AUTOSEEK_AT_MIN),this.seekWindowMs=Math.floor(e+.5)),this.seekWindowLength=Math.floor(this.sampleRate*this.sequenceMs/1e3),this.seekLength=Math.floor(this.sampleRate*this.seekWindowMs/1e3)},set quickSeek(t){this.bQuickSeek=t},clone:function(){var t=new Stretch;return t.tempo=this.tempo,t.setParameters(this.sampleRate,this.sequenceMs,this.seekWindowMs,this.overlapMs),t},seekBestOverlapPosition:function(){return this.bQuickSeek?this.seekBestOverlapPositionStereoQuick():this.seekBestOverlapPositionStereo()},seekBestOverlapPositionStereo:function(){var t,e,i,r;for(this.precalcCorrReferenceStereo(),e=Number.MIN_VALUE,t=0,r=0;r<this.seekLength;r++)i=this.calcCrossCorrStereo(2*r,this.pRefMidBuffer),i>e&&(e=i,t=r);return t},seekBestOverlapPositionStereoQuick:function(){var t,e,i,r,o,n,s;for(this.precalcCorrReferenceStereo(),i=Number.MIN_VALUE,e=0,n=0,s=0,o=0;4>o;o++){for(t=0;_SCAN_OFFSETS[o][t]&&(s=n+_SCAN_OFFSETS[o][t],!(s>=this.seekLength));)r=this.calcCrossCorrStereo(2*s,this.pRefMidBuffer),r>i&&(i=r,e=s),t++;n=e}return e},precalcCorrReferenceStereo:function(){var t,e,i;for(t=0;t<this.overlapLength;t++)i=t*(this.overlapLength-t),e=2*t,this.pRefMidBuffer[e]=this.pMidBuffer[e]*i,this.pRefMidBuffer[e+1]=this.pMidBuffer[e+1]*i},calcCrossCorrStereo:function(t,e){var i=this._inputBuffer.vector;t+=this._inputBuffer.startIndex;var r,o,n;for(r=0,o=2;o<2*this.overlapLength;o+=2)n=o+t,r+=i[n]*e[o]+i[n+1]*e[o+1];return r},overlap:function(t){this.overlapStereo(2*t)},overlapStereo:function(t){var e=this._inputBuffer.vector;t+=this._inputBuffer.startIndex;var i,r,o,n,s,u,a,f=this._outputBuffer.vector,h=this._outputBuffer.endIndex;for(n=1/this.overlapLength,i=0;i<this.overlapLength;i++)o=(this.overlapLength-i)*n,s=i*n,r=2*i,u=r+t,a=r+h,f[a+0]=e[u+0]*s+this.pMidBuffer[r+0]*o,f[a+1]=e[u+1]*s+this.pMidBuffer[r+1]*o},process:function(){var t,e,i;if(null==this.pMidBuffer){if(this._inputBuffer.frameCount<this.overlapLength)return;this.pMidBuffer=new Float32Array(2*this.overlapLength),this._inputBuffer.receiveSamples(this.pMidBuffer,this.overlapLength)}for(;this._inputBuffer.frameCount>=this.sampleReq;){e=this.seekBestOverlapPosition(),this._outputBuffer.ensureAdditionalCapacity(this.overlapLength),this.overlap(Math.floor(e)),this._outputBuffer.put(this.overlapLength),i=this.seekWindowLength-2*this.overlapLength,i>0&&this._outputBuffer.putBuffer(this._inputBuffer,e+this.overlapLength,i);var r=this.inputBuffer.startIndex+2*(e+this.seekWindowLength-this.overlapLength);this.pMidBuffer.set(this._inputBuffer.vector.subarray(r,r+2*this.overlapLength)),this.skipFract+=this.nominalSkip,t=Math.floor(this.skipFract),this.skipFract-=t,this._inputBuffer.receive(t)}}}),extend(Stretch.prototype,{get tempo(){return this._tempo}}),extend(SoundTouch.prototype,{clear:function(){rateTransposer.clear(),tdStretch.clear()},clone:function(){var t=new SoundTouch;return t.rate=rate,t.tempo=tempo,t},get rate(){return this._rate},set rate(t){this.virtualRate=t,this._calculateEffectiveRateAndTempo()},set rateChange(t){this.rate=1+.01*t},get tempo(){return this._tempo},set tempo(t){this.virtualTempo=t,this._calculateEffectiveRateAndTempo()},set tempoChange(t){this.tempo=1+.01*t},set pitch(t){this.virtualPitch=t,this._calculateEffectiveRateAndTempo()},set pitchOctaves(t){this.pitch=Math.exp(.69314718056*t),this._calculateEffectiveRateAndTempo()},set pitchSemitones(t){this.pitchOctaves=t/12},get inputBuffer(){return this._inputBuffer},get outputBuffer(){return this._outputBuffer},_calculateEffectiveRateAndTempo:function(){var t=this._tempo,e=this._rate;this._tempo=this.virtualTempo/this.virtualPitch,this._rate=this.virtualRate*this.virtualPitch,testFloatEqual(this._tempo,t)&&(this.tdStretch.tempo=this._tempo),testFloatEqual(this._rate,e)&&(this.rateTransposer.rate=this._rate),this._rate>1?this._outputBuffer!=this.rateTransposer.outputBuffer&&(this.tdStretch.inputBuffer=this._inputBuffer,this.tdStretch.outputBuffer=this._intermediateBuffer,this.rateTransposer.inputBuffer=this._intermediateBuffer,this.rateTransposer.outputBuffer=this._outputBuffer):this._outputBuffer!=this.tdStretch.outputBuffer&&(this.rateTransposer.inputBuffer=this._inputBuffer,this.rateTransposer.outputBuffer=this._intermediateBuffer,this.tdStretch.inputBuffer=this._intermediateBuffer,this.tdStretch.outputBuffer=this._outputBuffer)},process:function(){this._rate>1?(this.tdStretch.process(),this.rateTransposer.process()):(this.rateTransposer.process(),this.tdStretch.process())}});